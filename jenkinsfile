pipeline{
    agent any
    stages {

        stage('instance configuration'){
            steps{
                withCredentials([sshUserPrivateKey(credentialsId: 'Ansible', usernameVariable: 'USERNAME', keyFileVariable: 'KEYFILE')]) {
                    script {
                        
                        def remote = [:]
                        remote.name = 'ansible_server'
                        remote.host = '13.233.155.23'
                        remote.allowAnyHosts = true
                        remote.user = USERNAME
                        remote.identityFile = KEYFILE
                        // sh "ssh -i $KEYFILE $USERNAME@35.154.28.86"
                        
                        sshCommand remote: remote, command: 'sudo ansible-playbook /etc/ansible/Ansible/roles/03_playbook.yaml'
                    }
                }
                
            }
        }
    }
}